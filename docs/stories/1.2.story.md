# Story 1.2: Core Client and Base Models

## Status
Draft

## Story
**As a** developer,
**I want** to create the core async client class and foundational Pydantic models,
**so that** I have a type-safe foundation for interacting with the Companies House API.

## Acceptance Criteria
1. AsyncClient class is created with proper initialization and configuration
2. Base Pydantic models are created for core data structures (Address, RateLimitInfo)
3. Custom exception hierarchy is implemented for error handling
4. Configuration module handles API keys and client settings
5. All models have proper validation and type hints
6. Authentication handler correctly sets up HTTP Basic Auth
7. Client properly manages httpx.AsyncClient lifecycle
8. Rate limit information is extracted from response headers
9. Unit tests achieve 100% coverage of new code

## Tasks / Subtasks
- [ ] Create exceptions module (AC: 3)
  - [ ] Create base CompaniesHouseError exception
  - [ ] Create AuthenticationError for auth failures
  - [ ] Create RateLimitError with retry metadata
  - [ ] Create NotFoundError for 404 responses
  - [ ] Create ValidationError for data issues
  - [ ] Create ServerError for 5xx responses
  - [ ] Create NetworkError for connection issues
  - [ ] Write unit tests for exception hierarchy
- [ ] Create configuration module (AC: 4)
  - [ ] Define constants (BASE_URL, SANDBOX_URL, DEFAULT_TIMEOUT)
  - [ ] Create configuration class for client settings
  - [ ] Handle API key from environment or constructor
  - [ ] Validate configuration on initialization
  - [ ] Write unit tests for configuration
- [ ] Create base models (AC: 2, 5)
  - [ ] Create models/base.py with common base model
  - [ ] Create models/address.py with Address model
  - [ ] Create models/rate_limit.py with RateLimitInfo model
  - [ ] Ensure all fields have proper type hints
  - [ ] Add field validators where needed
  - [ ] Write unit tests for model validation
- [ ] Create authentication module (AC: 6)
  - [ ] Create auth.py with AuthHandler class
  - [ ] Implement HTTP Basic Auth header generation
  - [ ] Validate API key format
  - [ ] Write unit tests for authentication
- [ ] Create core client class (AC: 1, 7, 8)
  - [ ] Create client.py with AsyncClient class
  - [ ] Implement __init__ with configuration
  - [ ] Implement __aenter__ and __aexit__ for context manager
  - [ ] Create base request method with error handling
  - [ ] Extract rate limit info from response headers
  - [ ] Implement proper httpx.AsyncClient lifecycle management
  - [ ] Write unit tests for client initialization and lifecycle
- [ ] Integration testing (AC: 9)
  - [ ] Set up respx fixtures for mocked responses
  - [ ] Test client initialization with various configs
  - [ ] Test authentication header generation
  - [ ] Test rate limit header extraction
  - [ ] Test error handling for various HTTP status codes
  - [ ] Verify 100% code coverage

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Project structure established at src/ukcompanies/
- Development tools configured: pytest 8.3.0, ruff 0.7.0, mypy 1.11.0
- Test structure ready with conftest.py containing async fixtures
- All dependencies installed including httpx 0.28.1, pydantic 2.11.7

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
- `src/ukcompanies/exceptions.py` - Custom exception classes
- `src/ukcompanies/config.py` - Configuration and constants
- `src/ukcompanies/auth.py` - Authentication handler
- `src/ukcompanies/client.py` - AsyncClient main class
- `src/ukcompanies/models/base.py` - Base models with common fields
- `src/ukcompanies/models/address.py` - Address models
- `src/ukcompanies/models/rate_limit.py` - Rate limiting models

### Configuration Details
From architecture [Source: architecture/external-apis.md]:
- Production Base URL: `https://api.company-information.service.gov.uk`
- Sandbox Base URL: `https://api-sandbox.company-information.service.gov.uk`
- Authentication: HTTP Basic Auth with API key as username, empty password
- Default timeout: 30 seconds (as per error-handling-strategy.md)
- Rate limit: 600 requests per 5-minute window

### Model Specifications

**Address Model** [Source: architecture/data-models.md#Address]:
```python
- premises: Optional[str] - Building name/number
- address_line_1: str - First line of address
- address_line_2: Optional[str] - Second line of address
- locality: Optional[str] - Town/city
- region: Optional[str] - County/state
- postal_code: Optional[str] - Postcode
- country: Optional[str] - Country name
```

**RateLimitInfo Model** [Source: architecture/data-models.md#RateLimitInfo]:
```python
- remain: int - Remaining requests in window
- limit: int - Total requests allowed
- reset: datetime - When limit resets
- retry_after: Optional[int] - Seconds to wait if rate limited
```

### Exception Hierarchy
From architecture [Source: architecture/error-handling-strategy.md]:
```
CompaniesHouseError (base)
├── AuthenticationError - For authentication failures
├── RateLimitError - For 429 responses, includes retry metadata
├── NotFoundError - For 404 responses
├── ValidationError - For data validation issues
├── ServerError - For 5xx responses
├── NetworkError - For connection issues
```

### Critical Implementation Rules
From coding standards [Source: architecture/coding-standards.md]:
- Never use print() - use structlog logger exclusively
- All public methods must have type hints
- All API responses must use Pydantic models
- Never hardcode API keys or secrets
- Use httpx.AsyncClient as context manager with `async with`
- Validate company numbers: regex `^[0-9A-Z]{8}$` or `^[0-9]{7,8}$`
- Rate limit headers must always be checked and logged

### Testing

#### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]

**Test Organization:**
- Unit tests in `tests/unit/test_client.py`, `test_auth.py`, `test_exceptions.py`, `test_models.py`
- Integration tests in `tests/integration/` using respx for HTTP mocking
- All tests must follow AAA pattern (Arrange, Act, Assert)
- Mock all external dependencies in unit tests
- 100% code coverage requirement

**Specific Test Cases:**
- Test client initialization with valid/invalid API keys
- Test authentication header generation
- Test rate limit header extraction from responses
- Test all exception types with appropriate HTTP status codes
- Test model validation with valid and invalid data
- Test configuration from environment variables and constructor

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
_To be filled by the development agent during implementation_

### Agent Model Used
_Not yet implemented_

### Debug Log References
_Not yet implemented_

### Completion Notes List
_Not yet implemented_

### File List
_Not yet implemented_

## QA Results
_To be filled by QA agent after implementation_