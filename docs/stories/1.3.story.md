# Story 1.3: Search and Company Endpoints Implementation

## Status
Approved

## Story
**As a** developer,
**I want** to implement the search and company-related endpoints,
**so that** users can search for companies/officers and retrieve detailed company information.

## Acceptance Criteria
1. Search endpoints are implemented for both companies and officers
2. Company profile endpoint returns complete company information
3. Company address endpoint returns registered office address
4. Search_all endpoint provides paginated comprehensive search results
5. All responses use proper Pydantic models for validation
6. Error handling follows the established exception hierarchy
7. Rate limit information is properly extracted and returned
8. Retry logic is implemented for rate-limited requests
9. Unit tests achieve 100% coverage of new code
10. Integration tests verify endpoint behavior with mocked responses

## Tasks / Subtasks
- [ ] Create Company models (AC: 2, 5)
  - [ ] Create models/company.py with Company model
  - [ ] Add AccountingReference and ConfirmationStatement models
  - [ ] Add company status enums
  - [ ] Add jurisdiction and SIC code fields
  - [ ] Ensure all fields have proper type hints and validation
  - [ ] Write unit tests for model validation
- [ ] Create SearchResult models (AC: 1, 4, 5)
  - [ ] Create models/search.py with SearchResult model
  - [ ] Add CompanySearchItem and OfficerSearchItem models
  - [ ] Implement pagination fields (total_results, items_per_page, start_index)
  - [ ] Add kind field for result type identification
  - [ ] Write unit tests for search models
- [ ] Implement search_companies endpoint (AC: 1, 5, 6, 7)
  - [ ] Add search_companies method to AsyncClient
  - [ ] Implement query parameter construction
  - [ ] Map response to CompanySearchResult model
  - [ ] Handle error responses (404, 401, 429, 500)
  - [ ] Extract and return rate limit info
  - [ ] Write unit tests with respx mocks
- [ ] Implement search_officers endpoint (AC: 1, 5, 6, 7)
  - [ ] Add search_officers method to AsyncClient
  - [ ] Implement query parameter construction
  - [ ] Map response to OfficerSearchResult model
  - [ ] Handle error responses
  - [ ] Extract and return rate limit info
  - [ ] Write unit tests with respx mocks
- [ ] Implement profile endpoint (AC: 2, 5, 6, 7)
  - [ ] Add profile method to AsyncClient
  - [ ] Validate company number format (regex: ^[0-9A-Z]{8}$ or ^[0-9]{7,8}$)
  - [ ] Map response to Company model
  - [ ] Handle NotFoundError for invalid companies
  - [ ] Extract and return rate limit info
  - [ ] Write unit tests including validation edge cases
- [ ] Implement address endpoint (AC: 3, 5, 6, 7)
  - [ ] Add address method to AsyncClient
  - [ ] Validate company number format
  - [ ] Map response to Address model
  - [ ] Handle error responses
  - [ ] Extract and return rate limit info
  - [ ] Write unit tests with respx mocks
- [ ] Implement search_all paginated endpoint (AC: 4, 5, 6, 7)
  - [ ] Add search_all method to AsyncClient
  - [ ] Implement pagination parameters (per_page, max_pages)
  - [ ] Create async generator for streaming results
  - [ ] Aggregate results across pages
  - [ ] Handle rate limiting between pages
  - [ ] Extract and accumulate rate limit info
  - [ ] Write unit tests for pagination logic
- [ ] Implement retry logic (AC: 8)
  - [ ] Add retry logic to base request method
  - [ ] Implement exponential backoff with jitter
  - [ ] Use X-Ratelimit-Reset header for retry timing
  - [ ] Honor max_retries configuration
  - [ ] Call on_retry callback if configured
  - [ ] Write unit tests for retry scenarios
- [ ] Integration testing (AC: 10)
  - [ ] Create tests/integration/test_search_endpoints.py
  - [ ] Create tests/integration/test_company_endpoints.py
  - [ ] Test search with various query parameters
  - [ ] Test pagination handling in search_all
  - [ ] Test error scenarios (404, 401, 429)
  - [ ] Test retry logic with rate limiting
  - [ ] Verify 100% code coverage

## Dev Notes

### Previous Story Insights
From Story 1.2 (Core Client and Base Models):
- AsyncClient base class will be created with request method
- Base exception hierarchy will be established
- RateLimitInfo model will be available for use
- Authentication and configuration modules will be complete
- Address model will already exist in models/address.py

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
- `src/ukcompanies/models/company.py` - Company and related models
- `src/ukcompanies/models/search.py` - Search result models
- `src/ukcompanies/client.py` - Add endpoint methods to AsyncClient
- `tests/unit/test_search.py` - Unit tests for search functionality
- `tests/unit/test_company.py` - Unit tests for company endpoints
- `tests/integration/test_search_endpoints.py` - Integration tests for search
- `tests/integration/test_company_endpoints.py` - Integration tests for company

### API Endpoint Details
From architecture [Source: architecture/external-apis.md]:

**Search Companies**:
- Endpoint: `/search/companies`
- Parameters: `q` (query term), `items_per_page`, `start_index`
- Returns: Paginated list of matching companies

**Search Officers**:
- Endpoint: `/search/officers`
- Parameters: `q` (query term), `items_per_page`, `start_index`
- Returns: Paginated list of matching officers

**Company Profile**:
- Endpoint: `/company/{company_number}`
- Returns: Complete company information

**Company Address**:
- Endpoint: `/company/{company_number}/registered-office-address`
- Returns: Registered office address

**Search All**:
- Endpoint: `/search`
- Parameters: `q` (query term), `items_per_page`, `start_index`
- Returns: Combined results (companies, officers, disqualified officers)

### Model Specifications

**Company Model** [Source: architecture/data-models.md#Company]:
```python
- company_number: str - Unique 8-character identifier
- company_name: str - Registered company name
- company_status: str - Active, dissolved, liquidation, etc.
- date_of_creation: date - Company incorporation date
- jurisdiction: str - Registration jurisdiction
- sic_codes: List[str] - Standard Industrial Classification codes
- registered_office_address: Address - Official company address
- accounts: AccountingReference - Accounting reference dates
- confirmation_statement: ConfirmationStatement - Annual confirmation info
```

**SearchResult Model** [Source: architecture/data-models.md#SearchResult]:
```python
- items: List[Union[Company, Officer]] - Search result items
- total_results: int - Total matches found
- items_per_page: int - Pagination size
- start_index: int - Starting position
- kind: str - Type of search results
```

### Rate Limiting and Retry
From features [Source: prd/features.md#Retry-Logic]:
- Auto-retry for 429 responses when enabled
- Exponential backoff with jitter
- Max 3 retries by default (configurable)
- Use X-Ratelimit-Reset header for timing
- Optional on_retry callback for logging

### Critical Implementation Rules
From coding standards [Source: architecture/coding-standards.md]:
- Never use print() - use structlog logger exclusively
- All public methods must have type hints
- All API responses must use Pydantic models
- Validate company numbers: regex `^[0-9A-Z]{8}$` or `^[0-9]{7,8}$`
- Rate limit headers must always be checked and logged
- Use httpx.AsyncClient methods for HTTP requests
- Handle all documented HTTP status codes

### Testing

#### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]

**Test Organization:**
- Unit tests in `tests/unit/test_search.py`, `test_company.py`
- Integration tests in `tests/integration/test_search_endpoints.py`, `test_company_endpoints.py`
- Use respx for mocking HTTP responses
- Follow AAA pattern (Arrange, Act, Assert)
- 100% code coverage requirement

**Specific Test Cases:**
- Test search with various query terms and special characters
- Test pagination with different page sizes
- Test company number validation (valid/invalid formats)
- Test 404 handling for non-existent companies
- Test 429 rate limiting and retry behavior
- Test search_all generator with multiple pages
- Test error mapping to custom exceptions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Scrum Master Agent |

## Dev Agent Record
_To be filled by the development agent during implementation_

### Agent Model Used
_Not yet implemented_

### Debug Log References
_Not yet implemented_

### Completion Notes List
_Not yet implemented_

### File List
_Not yet implemented_

## QA Results
_To be filled by QA agent after implementation_