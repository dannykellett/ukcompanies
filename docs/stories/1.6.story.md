# Story 1.6: Retry Logic and Rate Limiting Implementation

## Status
Draft

## Story
**As a** developer using the ukcompanies SDK,
**I want** automatic retry logic for rate-limited requests,
**so that** my application can handle API rate limits gracefully without manual intervention.

## Acceptance Criteria
1. Client supports automatic retry for 429 (rate-limited) responses
2. Configurable retry parameters: auto_retry, max_retries, backoff strategy
3. Exponential backoff with jitter implemented for retry delays
4. Fixed backoff strategy available as alternative option
5. Respect X-Ratelimit-Reset header for intelligent wait times
6. Optional on_retry callback for logging/monitoring retry attempts
7. Proper error propagation when max retries exceeded
8. Rate limit information extracted and included in RateLimitError
9. Retry logic is non-blocking and maintains async behavior
10. Unit tests achieve 100% coverage of retry module
11. Integration tests verify retry behavior with mocked 429 responses

## Tasks / Subtasks
- [ ] Create retry.py module with retry logic (AC: 1, 2, 3, 4)
  - [ ] Create RetryConfig class with configuration parameters
  - [ ] Implement exponential_backoff function with jitter
  - [ ] Implement fixed_backoff function as alternative
  - [ ] Create RetryManager class to handle retry logic
  - [ ] Add backoff strategy enum (exponential, fixed)
  - [ ] Write unit tests for backoff calculations
- [ ] Parse and use rate limit headers (AC: 5, 8)
  - [ ] Extract X-Ratelimit-Reset header from responses
  - [ ] Calculate wait time from reset timestamp
  - [ ] Prefer reset time over calculated backoff when available
  - [ ] Include rate limit info in RateLimitError
  - [ ] Write tests for header parsing logic
- [ ] Integrate retry logic into AsyncClient (AC: 1, 6, 7, 9)
  - [ ] Update client.__init__ to accept retry configuration
  - [ ] Wrap request method with retry logic
  - [ ] Call on_retry callback before each retry attempt
  - [ ] Maintain async behavior throughout retry loop
  - [ ] Raise RateLimitError after max retries exceeded
  - [ ] Write unit tests with mocked responses
- [ ] Update RateLimitError exception (AC: 8)
  - [ ] Add rate_limit_remain field
  - [ ] Add rate_limit_limit field  
  - [ ] Add rate_limit_reset field (as datetime)
  - [ ] Add retry_after field (seconds to wait)
  - [ ] Update exception message to include retry info
  - [ ] Write tests for exception creation
- [ ] Create configuration interface (AC: 2)
  - [ ] Add auto_retry parameter to AsyncClient (default: True)
  - [ ] Add max_retries parameter (default: 3)
  - [ ] Add backoff parameter (default: "exponential")
  - [ ] Add on_retry parameter (optional callback)
  - [ ] Validate configuration parameters
  - [ ] Write tests for configuration validation
- [ ] Implement callback mechanism (AC: 6)
  - [ ] Define on_retry callback signature
  - [ ] Pass attempt number, wait time, and response to callback
  - [ ] Handle callback exceptions gracefully
  - [ ] Make callback async-compatible
  - [ ] Write tests with various callback scenarios
- [ ] Handle edge cases (AC: 7, 9)
  - [ ] Ensure retries don't block event loop
  - [ ] Handle network errors during retry
  - [ ] Preserve original exception context
  - [ ] Handle missing rate limit headers gracefully
  - [ ] Write tests for edge cases
- [ ] Integration testing (AC: 11)
  - [ ] Create tests/integration/test_retry_logic.py
  - [ ] Test successful retry after 429
  - [ ] Test max retries exceeded scenario
  - [ ] Test with real-like rate limit headers
  - [ ] Test callback invocation
  - [ ] Test both backoff strategies
  - [ ] Verify async behavior maintained
  - [ ] Achieve 100% code coverage

## Dev Notes

### Previous Story Insights
From Story 1.5 (Filing History and Document Endpoints):
- Rate limit extraction patterns established in client methods
- RateLimitInfo model available for rate limit data
- Pattern for handling 429 responses in integration tests

From Story 1.2 (Core Client and Base Models):
- AsyncClient base class with request method that needs retry wrapping
- Exception hierarchy established with RateLimitError
- httpx.AsyncClient usage patterns established

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
- `src/ukcompanies/retry.py` - New retry logic module
- `src/ukcompanies/client.py` - Update AsyncClient to integrate retry logic
- `src/ukcompanies/exceptions.py` - Update RateLimitError with new fields
- `src/ukcompanies/config.py` - Add retry configuration constants
- `tests/unit/test_retry.py` - Unit tests for retry module
- `tests/integration/test_retry_logic.py` - Integration tests for retry behavior

### Retry Implementation Details
From PRD requirements [Source: prd/features.md#Retry-Logic]:
- Automatic retry for rate-limited requests (429 status)
- Configurable parameters:
  - `auto_retry`: Enable/disable automatic retries
  - `max_retries`: Maximum retry attempts (default: 3)
  - `backoff`: Strategy ("exponential" or "fixed")
  - `on_retry`: Optional callback for logging
- Must respect `X-Ratelimit-Reset` for accurate delay

### Rate Limit Headers
From API documentation [Source: architecture/external-apis.md]:
- `X-Ratelimit-Remain`: Remaining requests in current window
- `X-Ratelimit-Limit`: Total requests allowed in window (600)
- `X-Ratelimit-Reset`: Unix timestamp when limit resets
- Headers must be parsed and included in retry logic

### Backoff Strategies
From error handling strategy [Source: architecture/error-handling-strategy.md#External-API-Errors]:
- Exponential backoff with jitter
- Max 3 retries by default, configurable via client
- Base delay calculation: `min(2^attempt * base_delay + jitter, max_delay)`
- Jitter range: 0-1 seconds randomly added
- Base delay: 1 second
- Max delay: 60 seconds

### Callback Signature
The on_retry callback should have this signature:
```python
async def on_retry(attempt: int, wait: float, response: httpx.Response) -> None:
    """
    Called before each retry attempt.
    
    Args:
        attempt: Retry attempt number (1-based)
        wait: Seconds to wait before retry
        response: The 429 response that triggered retry
    """
```

### Critical Implementation Rules
From coding standards [Source: architecture/coding-standards.md]:
- Never use print() - use structlog logger exclusively
- All public methods must have type hints
- Use httpx.AsyncClient context manager properly
- Rate limit headers must always be checked and logged
- All async functions must be prefixed with async
- Never block the event loop with synchronous sleep

### Configuration Constants
Add to config.py [Source: architecture/source-tree.md]:
```python
DEFAULT_AUTO_RETRY = True
DEFAULT_MAX_RETRIES = 3
DEFAULT_BACKOFF_STRATEGY = "exponential"
BASE_DELAY = 1.0  # seconds
MAX_DELAY = 60.0  # seconds
JITTER_RANGE = 1.0  # seconds
```

## Developer Instructions

- Branch from: `main`
- Branch name: `feature/story-1.6`
- PR target: `main`
- Commits: One per acceptance criterion
- PR title: `[Story 1.6] Retry Logic and Rate Limiting Implementation`
- PR description:
  Implements `docs/stories/1.6.story.md`  
  Includes retry logic and rate limiting features with tests and documentation.

## Create PR (CLI)

```bash
gh pr create --base main --head feature/story-1.6 \
  --title "[Story 1.6] Retry Logic and Rate Limiting Implementation" \
  --body "Implements docs/stories/1.6.story.md"
```

## Testing

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]

**Test Organization:**
- Unit tests in `tests/unit/test_retry.py`
- Integration tests in `tests/integration/test_retry_logic.py`
- Use respx for mocking HTTP responses
- Mock 429 responses with rate limit headers
- 100% code coverage requirement

**Specific Test Cases:**
- Test exponential backoff calculation with jitter
- Test fixed backoff as alternative strategy
- Test X-Ratelimit-Reset header parsing and usage
- Test on_retry callback invocation
- Test max retries exceeded scenario
- Test successful retry on second attempt
- Test async behavior maintained during retries
- Test missing rate limit headers handling
- Test network errors during retry attempts
- Test configuration validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Scrum Master Agent |

## Dev Agent Record
_To be filled by the development agent during implementation_

### Agent Model Used
_Not yet implemented_

### Debug Log References
_Not yet implemented_

### Completion Notes List
_Not yet implemented_

### File List
_Not yet implemented_

## QA Results
_To be filled by QA agent after implementation_